# Docker Compose for CactiAutomation
# Provides: web app, Redis (for future task queue), and volumes for persistence

version: '3.8'

services:
  # ==========================================================================
  # Main Application
  # ==========================================================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cacti-web
    restart: unless-stopped
    ports:
      - "${PORT:-5000}:5000"
    environment:
      - ENV=${ENV:-production}
      - DEBUG=${DEBUG:-false}
      - HOST=0.0.0.0
      - PORT=5000
      - SELENIUM_HEADLESS=true
      - CACTI_BASE_URL=${CACTI_BASE_URL}
      - CACTI_ALLOWED_URLS=${CACTI_ALLOWED_URLS}
      - CACTI_USERNAME=${CACTI_USERNAME}
      - CACTI_PASSWORD=${CACTI_PASSWORD}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:5000}
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - cacti-output:/app/output
      - cacti-logs:/app/logs
      - ./models:/app/models:ro # OCR models (read-only)
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - cacti-network
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==========================================================================
  # Redis - For task queue and caching (future use)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: cacti-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - cacti-redis:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - cacti-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
  # ==========================================================================
  # Celery Worker (for future task queue)
  # ==========================================================================
  # worker:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: cacti-worker
  #   restart: unless-stopped
  #   command: celery -A tasks.celery_app worker --loglevel=info --concurrency=2
  #   environment:
  #     - ENV=${ENV:-production}
  #     - REDIS_URL=redis://redis:6379/0
  #     - CACTI_USERNAME=${CACTI_USERNAME}
  #     - CACTI_PASSWORD=${CACTI_PASSWORD}
  #   volumes:
  #     - cacti-output:/app/output
  #     - cacti-logs:/app/logs
  #   depends_on:
  #     - redis
  #     - web
  #   networks:
  #     - cacti-network

  # ==========================================================================
  # Celery Beat Scheduler (for future scheduled tasks)
  # ==========================================================================
  # scheduler:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: cacti-scheduler
  #   restart: unless-stopped
  #   command: celery -A tasks.celery_app beat --loglevel=info
  #   environment:
  #     - REDIS_URL=redis://redis:6379/0
  #   depends_on:
  #     - redis
  #   networks:
  #     - cacti-network

  # ==========================================================================
  # Networks
  # ==========================================================================
networks:
  cacti-network:
    driver: bridge

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  cacti-output:
    name: cacti-output
  cacti-logs:
    name: cacti-logs
  cacti-redis:
    name: cacti-redis
